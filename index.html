<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login com Google - Cuide-me</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Inter', sans-serif;
      background: #f4fbfe;
      color: #245063;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      margin-top: 4vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .logo {
      width: 110px;
      margin-bottom: 1.6rem;
    }
    .google-btn {
      min-width: 260px;
      font-size: 1.2rem;
      background: #fff;
      color: #333;
      border: 2px solid #d5dbe0;
      border-radius: 32px;
      padding: 1rem 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 1.1rem;
      cursor: pointer;
      box-shadow: 0 2px 18px #0001;
      margin-bottom: 1.2rem;
      transition: border .2s;
    }
    .google-btn:active,
    .google-btn:focus {
      border: 2px solid #42c2d3;
      outline: 0;
    }
    .google-btn img {
      width: 32px;
      height: 32px;
    }
    .form-centro {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 22px #0001;
      padding: 2rem 1.5rem 1.2rem 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 300px;
      max-width: 340px;
      margin: 0 auto;
      gap: 0.8rem;
      margin-bottom: 1.2rem;
    }
    .form-centro input, .form-centro button {
      width: 100%;
      max-width: 320px;
      min-height: 52px;
      font-size: 1.13rem;
      border-radius: 10px;
      padding: 0 1rem;
      background: #eaf1fa;
      color: #245063;
      border: 2px solid #b3c5cf;
      margin-bottom: 0.9rem;
      transition: border-color .2s;
    }
    .form-centro input:focus {
      border-color: #42c2d3;
      background: #f3fbfd;
      outline: 3px solid #42c2d388;
    }
    .form-centro button.cta-btn {
      background-color: #42c2d3;
      color: #fff;
      font-weight: 700;
      min-height: 52px;
      font-size: 1.18rem;
      margin-bottom: 0.2rem;
      border: none;
      cursor: pointer;
      border-radius: 32px;
      box-shadow: 0 2px 8px #42c2d311;
    }
    .loading-spinner { display: inline-block; width: 22px; height: 22px; border: 3px solid #fff; border-top: 3px solid #42c2d3; border-radius: 50%; animation: spin 1s linear infinite; position: absolute; right: 18px; top: 50%; transform: translateY(-50%);}
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .msg-erro {
      background: #fff3f3;
      color: #b00020;
      padding: 0.85rem 1rem;
      border-radius: 8px;
      margin-bottom: 1.1rem;
      font-weight: 600;
      font-size: 1rem;
      border: 1.5px solid #ff6868;
      box-shadow: 0 2px 12px #0001;
      display: none;
      text-align: center;
    }
    @media (max-width:480px) {
      .form-centro { min-width: 96vw; max-width: 99vw; }
      .google-btn { min-width: 90vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo_cuide_me.png" alt="Logo Cuide-me" class="logo" />
    <div id="erroMsg" class="msg-erro"></div>
    <button class="google-btn" onclick="entrarComGoogle()">
      <img src="https://img.icons8.com/color/48/google-logo.png" alt="Google"/>
      Entrar com Google
    </button>
    <div id="formGoogle"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCAIq_rBcV0i2q_xrXucrEVXFDpdA1eBDo",
      authDomain: "cuide-me-f57f8.firebaseapp.com",
      projectId: "cuide-me-f57f8",
      storageBucket: "cuide-me-f57f8.appspot.com",
      messagingSenderId: "846926668384",
      appId: "1:846926668384:web:c8022e110171969f6b5905"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Airtable config
    const airtableBaseId = 'appVxCKjvJAah2r27';
    const airtableApiKey = 'patrmTBeVgEPAzvS0.32c80ba0e8212db59f5fd216d9c60dfd120bc30e35e4ff0d5e5da1112da1d9a2';

    function showErro(msg) {
      const erroDiv = document.getElementById('erroMsg');
      erroDiv.innerText = msg;
      erroDiv.style.display = 'block';
      setTimeout(()=>{erroDiv.style.display='none'}, 4000);
    }

    // Verifica se UID/email já está no Airtable
    async function checarExistenciaAirtable(uid, email) {
      const url = `https://api.airtable.com/v0/${airtableBaseId}/Clientes?filterByFormula=OR({UID}='${uid}',LOWER({E-mail})='${email.trim().toLowerCase()}')`;
      const response = await fetch(url, { headers: { 'Authorization': `Bearer ${airtableApiKey}` } });
      const data = await response.json();
      return data.records && data.records.length > 0;
    }

    function mascaraCPF(cpf) {
      return cpf.replace(/\D/g, "")
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
    }

    // Valida CPF
    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, '');
      if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(10))) return false;
      return true;
    }

    // 1. Usuário clica no botão Google
    async function entrarComGoogle() {
      document.getElementById('erroMsg').style.display = 'none';
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        // 2. Se usuário já existe no Firebase: entra direto
        if (!user) throw new Error("Não foi possível autenticar com Google.");
        // Consulta no Airtable se já está cadastrado
        const jaCadastrado = await checarExistenciaAirtable(user.uid, user.email);
        if (jaCadastrado) {
          window.location.href = "pagina-homepage.html";
        } else {
          // 3. Primeiro acesso: pede nome e CPF
          renderFormNomeCpfGoogle(user);
        }
      } catch (err) {
        // Se foi erro de "popup closed", ignora
        if (err.code && err.code === 'auth/popup-closed-by-user') return;
        // Firebase cria usuário Google mesmo no primeiro login,
        // por isso, se for erro de cadastro, mostra erro geral.
        showErro("Falha no login Google. Tente novamente.");
      }
    }

    // Formulário Nome/CPF após login Google (primeiro acesso)
    function renderFormNomeCpfGoogle(userGoogle) {
      document.getElementById('formGoogle').innerHTML = `
        <form class="form-centro" id="cadastroGoogleForm" autocomplete="off" onsubmit="return false;">
          <h3 style="margin:0 0 0.7rem 0;font-weight:700;font-size:1.25rem;">Complete seu cadastro</h3>
          <input id="nomeGoogle" name="nome" type="text" placeholder="Nome completo" required aria-label="Nome completo"/>
          <input id="cpfGoogle" name="cpf" type="text" placeholder="CPF" required maxlength="14" aria-label="CPF"/>
          <button class="cta-btn" id="btnCadastrarGoogle" type="submit" aria-label="Cadastrar">Cadastrar</button>
        </form>
      `;
      document.getElementById("cpfGoogle").addEventListener('input', e => {
        e.target.value = mascaraCPF(e.target.value);
      });
      document.getElementById("cadastroGoogleForm").onsubmit = () => cadastrarGoogleFinal(userGoogle);
    }

    async function cadastrarGoogleFinal(userGoogle) {
      const btn = document.getElementById("btnCadastrarGoogle");
      btn.disabled = true;
      btn.innerHTML = "Enviando <span class='loading-spinner'></span>";
      const nome = document.getElementById("nomeGoogle").value.trim();
      const cpf = document.getElementById("cpfGoogle").value.replace(/\D/g, '');
      if (!nome || nome.length < 3) { showErro("Digite seu nome completo."); btn.disabled=false; btn.innerHTML="Cadastrar"; return;}
      if (!validarCPF(cpf)) { showErro("Digite um CPF válido."); btn.disabled=false; btn.innerHTML="Cadastrar"; return; }
      // Cadastra no Airtable
      const user = userGoogle;
      await fetch(`https://api.airtable.com/v0/${airtableBaseId}/Clientes`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${airtableApiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({fields:{
          "Nome Completo": nome,
          "CPF": cpf,
          "E-mail": user.email,
          "UID": user.uid,
          "Fonte de cadastro": "google"
        }})
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) showErro('Erro ao salvar: ' + data.error.message);
        else window.location.href = "pagina-homepage.html";
      })
      .catch(err => showErro('Erro geral: ' + err.message))
      .finally(() => { btn.disabled=false; btn.innerHTML="Cadastrar"; });
    }
  </script>
</body>
</html>
