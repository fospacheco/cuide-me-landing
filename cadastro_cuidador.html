<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro de Cuidador • Cuide-me</title>

  <!-- Preconnect para otimizar carregamento de fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- Google Fonts: Poppins e Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS CDN (substituir por build local em produção) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --primary-color: #4a90e2; /* Variável da paleta Cuide-me */
    }
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Modal LGPD: acessível via roles e aria -->
  <div id="lgpdModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4" role="dialog" aria-modal="true" aria-labelledby="lgpdTitle" aria-describedby="lgpdDesc">
    <div class="bg-white rounded-2xl shadow-lg p-6 max-w-md w-full">
      <h2 id="lgpdTitle" class="text-xl font-semibold mb-2 text-center">Antes de continuar...</h2>
      <p id="lgpdDesc" class="mb-4">Você precisa aceitar nossa Política de Privacidade para prosseguir.</p>
      <label class="flex items-center space-x-2 mb-4">
        <input type="checkbox" id="chkConsent" class="h-4 w-4 accent-[var(--primary-color)] focus:ring-2 focus:ring-[var(--primary-color)]" />
        <span>Li e concordo com a <a href="/pagina_politica_de_privacidade.html" class="text-[var(--primary-color)] underline" target="_blank">Política de Privacidade</a></span>
      </label>
      <button id="btnAccept" disabled class="w-full py-2 px-4 bg-[var(--primary-color)] text-white font-semibold rounded-lg disabled:opacity-50 focus:outline-none focus:ring-4 focus:ring-[var(--primary-color)] focus:ring-opacity-50">Aceitar</button>
    </div>
  </div>

  <!-- Formulário de cadastro oculto até aceitação do LGPD -->
  <main class="min-h-screen flex items-center justify-center p-4">
    <form id="cadastroForm" class="hidden bg-white rounded-2xl shadow-lg p-6 max-w-lg w-full flex flex-col space-y-4" aria-hidden="true">
      <h1 class="text-2xl font-semibold mb-4 text-center">Cadastro de Cuidador</h1>
      <!-- Campo Nome -->
      <div>
        <label for="nome" class="block text-sm font-medium mb-1">Nome completo</label>
        <input type="text" id="nome" name="nome" required class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]" />
      </div>
      <!-- Campo CPF com máscara -->
      <div>
        <label for="cpf" class="block text-sm font-medium mb-1">CPF</label>
        <input type="text" id="cpf" name="cpf" required maxlength="14" placeholder="000.000.000-00" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]" />
      </div>
      <!-- Campo E-mail -->
      <div>
        <label for="email" class="block text-sm font-medium mb-1">E-mail</label>
        <input type="email" id="email" name="email" required class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]" />
      </div>
      <!-- Campo Senha -->
      <div>
        <label for="senha" class="block text-sm font-medium mb-1">Senha (mínimo 6 caracteres)</label>
        <input type="password" id="senha" name="senha" required minlength="6" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)]" />
      </div>
      <!-- Botão de Cadastro -->
      <button type="submit" class="py-2 px-4 bg-[var(--primary-color)] text-white font-semibold rounded-lg focus:outline-none focus:ring-4 focus:ring-[var(--primary-color)] focus:ring-opacity-50">Cadastrar</button>
    </form>
  </main>

  <!-- Script Módulo: Firebase e integração com Airtable -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, setPersistence, browserSessionPersistence, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Configuração do Firebase (substitua pelos seus dados)
    const firebaseConfig = { /* seu config do Firebase */ };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserSessionPersistence);

    // Lógica do Modal LGPD
    const modal = document.getElementById('lgpdModal');
    const chkConsent = document.getElementById('chkConsent');
    const btnAccept = document.getElementById('btnAccept');
    const form = document.getElementById('cadastroForm');

    chkConsent.addEventListener('change', () => { btnAccept.disabled = !chkConsent.checked; });
    btnAccept.addEventListener('click', () => {
      modal.classList.add('hidden');
      form.classList.remove('hidden');
      form.removeAttribute('aria-hidden');
    });

    // Máscara de CPF
    document.getElementById('cpf').addEventListener('input', e => {
      let v = e.target.value.replace(/\D/g, '');
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = v;
    });

    // Envio do formulário para Firebase e Airtable
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const nome = form.nome.value.trim();
      const cpf = form.cpf.value.replace(/\D/g, '');
      const email = form.email.value.trim();
      const senha = form.senha.value;
      try {
        // 1) Cria usuário no Firebase
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        const uid = cred.user.uid;
        // 2) Envia para o Airtable
        const airtableBase = 'appVxCKjvJAah2r27';
        const airtableKey = 'Bearer seu_token_aqui';
        const table = 'Cuidadores';
        const fields = {
          'UID': uid,
          'Nome Completo': nome,
          'CPF': cpf,
          'E-mail': email,
          'Status': 'Pendente'
        };
        const res = await fetch(`https://api.airtable.com/v0/${airtableBase}/${encodeURIComponent(table)}`, {
          method: 'POST',
          headers: { 'Authorization': airtableKey, 'Content-Type': 'application/json' },
          body: JSON.stringify({ fields })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        // 3) Redireciona para o painel de especialista
        window.location.href = '/pagina_especialista.html';
      } catch (err) {
        console.error(err);
        alert('Erro no cadastro: ' + err.message);
      }
    });
  </script>
</body>
</html>
